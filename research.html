<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Paper Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="referrer" content="no-referrer"/>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow py-6">
    <div class="container mx-auto px-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold text-gray-800">Paper Search</h1>
      <a href="./index.html" class="text-blue-600 hover:underline">← Back</a>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <!-- Controls -->
    <div class="bg-white rounded-xl shadow p-4 mb-6 grid grid-cols-1 lg:grid-cols-6 gap-3">
      <input id="query" type="text" class="border rounded-lg px-3 py-2 col-span-2"
             value="(coronavirus OR SARS-CoV-2) AND spike AND antibody response"
             placeholder="Enter search terms"/>
      <input id="author" type="text" class="border rounded-lg px-3 py-2"
             placeholder="author"/>
      <select id="journal" class="border rounded-lg px-3 py-2">
        <option value="">All Journals</option>
        <option value="(nature[journal] OR science[journal] OR cell[journal])">
          CNS
        </option>
        <option value='("Molecular Cell"[journal]
                        OR "The Journal of Cell Biology"[journal]
                        OR "Nature Immunology"[journal]
                        OR "Immunity"[journal]
                        OR "Cell Host & Microbe"[journal]
                        OR "Nature Reviews Molecular Cell Biology"[journal]
                        OR "Nature Medicine"[journal]
                        OR PNAS[journal]
                        OR "Nature Communications"[journal]
                        OR "Nature Structural & Molecular Biology"[journal]
                        OR "Science Translational Medicine"[journal])'>
          Hi
        </option>
          <option value="(biorxiv[source] OR medrxiv[source])">bioRxiv + medRxiv</option>
      </select>
      <select id="dateRange" class="border rounded-lg px-3 py-2">
        <option value="">Any Time</option>
        <option value="1y">Last 1 year</option>
        <option value="3y">Last 3 years</option>
        <option value="5y">Last 5 years</option>
        <option value="custom">Custom Range</option>
      </select>
      <div class="flex gap-1">
        <input type="date" id="startDate" class="border rounded-lg px-2 py-1 hidden">
        <input type="date" id="endDate" class="border rounded-lg px-2 py-1 hidden">
      </div>
      <select id="sort" class="border rounded-lg px-3 py-2">
        <option value="most+recent" selected>Most Recent</option>
        <option value="relevance">Relevance</option>
      </select>
      <button id="run" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Search</button>
    </div>

    <p id="updated" class="text-sm text-gray-500 mb-6"></p>

    <!-- PubMed Results -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold text-gray-800">PubMed</h2>
        <div class="flex items-center gap-3">
          <button id="saveSelected" class="px-3 py-1 rounded-lg bg-green-600 text-white hover:bg-green-700 text-sm hidden">Save Selected</button>
          <a href="saved.html" class="text-blue-600 hover:underline text-sm">Saved Papers</a>
          <div class="text-sm text-gray-500">Auto loaded</div>
        </div>
      </div>
      <div id="pubmed" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      <div id="pubmedMore" class="mt-4 text-center hidden">
        <button id="loadMorePubmed" class="px-4 py-2 rounded-lg border">Load more</button>
      </div>
    </section>
  </main>

  <footer class="bg-gray-800 text-white py-6 mt-12">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2025 SuncheolP</p>
    </div>
  </footer>

  <script>
    const updated = document.getElementById('updated');
    const dateRangeSel = document.getElementById('dateRange');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');

    dateRangeSel.addEventListener('change', () => {
      if (dateRangeSel.value === 'custom') {
        startDateInput.classList.remove('hidden');
        endDateInput.classList.remove('hidden');
      } else {
        startDateInput.classList.add('hidden');
        endDateInput.classList.add('hidden');
      }
    });

    function setUpdated() {
      updated.textContent = `Last updated: ${new Date().toLocaleString()}`;
    }
    function getQuery() {
      const baseQuery = document.getElementById('query').value.trim();
      const authorFilter = document.getElementById('author').value.trim();
      const journalFilter = document.getElementById('journal').value;
      let query = baseQuery;
      if (authorFilter) {
        query += ` AND ${authorFilter}[author]`;
      }
      return journalFilter ? `${query} AND ${journalFilter}` : query;
    }
    function getDateParams() {
      const today = new Date();
      let mindate = '', maxdate = '';
      if (dateRangeSel.value === '1y') {
        mindate = `${today.getFullYear()-1}/01/01`;
      } else if (dateRangeSel.value === '3y') {
        mindate = `${today.getFullYear()-3}/01/01`;
      } else if (dateRangeSel.value === '5y') {
        mindate = `${today.getFullYear()-5}/01/01`;
      } else if (dateRangeSel.value === 'custom') {
        mindate = startDateInput.value;
        maxdate = endDateInput.value;
      }
      return { mindate, maxdate };
    }

    const pubmedDiv = document.getElementById('pubmed');
    const moreBtnWrap = document.getElementById('pubmedMore');
    const moreBtn = document.getElementById('loadMorePubmed');
    let retstart = 0, retmax = 20, lastQuery = '', lastSort = 'most+recent';

    async function fetchPubMed(query, sort='most+recent', append=false) {
      const { mindate, maxdate } = getDateParams();
      const dateParams = mindate ? `&mindate=${mindate}${maxdate ? `&maxdate=${maxdate}` : ''}` : '';
      const term = encodeURIComponent(query);
      const esearch = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmode=json&retmax=${retmax}&retstart=${retstart}&sort=${sort}${dateParams}&term=${term}`;
      const e1 = await fetch(esearch).then(r=>r.json()).catch(()=>null);
      const ids = (e1 && e1.esearchresult && e1.esearchresult.idlist) || [];
      if (!append) pubmedDiv.innerHTML = '';
      moreBtnWrap.classList.toggle('hidden', ids.length < retmax);
      if (ids.length === 0) {
        if (!append) pubmedDiv.innerHTML = `<div class="text-gray-500">No results.</div>`;
        return;
      }

      const idStr = ids.join(',');
      const esummary = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&retmode=json&id=${idStr}`;
      const e2 = await fetch(esummary).then(r=>r.json()).catch(()=>null);
      const result = e2 && e2.result ? e2.result : {};
      ids.forEach(id => {
        const it = result[id]; if (!it) return;
        const title = it.title || '(no title)';
        const journal = it.fulljournalname || it.source || '';
        const date = it.pubdate || it.epubdate || '';
        const authors = (it.authors||[]).map(a=>a.name).join(', ');
        const pmid = it.uid;
        const link = `https://pubmed.ncbi.nlm.nih.gov/${pmid}/`;
        const cardWrapper = document.createElement('div');
        cardWrapper.className = 'relative bg-white rounded-xl shadow hover:shadow-lg transition p-4';
        cardWrapper.innerHTML = `
          <div class="absolute top-3 right-3">
            <input type="checkbox" class="paper-checkbox w-5 h-5" data-pmid="${pmid}" 
                   data-title="${title.replace(/"/g, '&quot;')}" 
                   data-journal="${journal.replace(/"/g, '&quot;')}" 
                   data-date="${date.replace(/"/g, '&quot;')}" 
                   data-authors="${authors.replace(/"/g, '&quot;')}" 
                   data-link="${link}">
          </div>
          <a href="${link}" target="_blank" rel="noopener" class="block">
            <div class="text-lg font-semibold text-gray-800 mb-1 pr-8">${title}</div>
            <div class="text-sm text-gray-600">${journal} · ${date}</div>
            <div class="text-sm text-gray-600 truncate">${authors}</div>
            <div class="mt-2 text-blue-600 text-sm">PMID: ${pmid}</div>
          </a>
        `;
        pubmedDiv.appendChild(cardWrapper);
      });
    }

    document.getElementById('run').addEventListener('click', () => {
      retstart = 0;
      lastQuery = getQuery();
      lastSort = document.getElementById('sort').value;
      fetchPubMed(lastQuery, lastSort, false).then(setUpdated);
    });

    moreBtn.addEventListener('click', () => {
      retstart += retmax;
      fetchPubMed(lastQuery, lastSort, true).then(setUpdated);
    });

    // 논문 저장 기능
    const saveBtn = document.getElementById('saveSelected');
    
    function updateSaveButton() {
      const checked = document.querySelectorAll('.paper-checkbox:checked');
      saveBtn.classList.toggle('hidden', checked.length === 0);
    }

    pubmedDiv.addEventListener('change', (e) => {
      if (e.target.classList.contains('paper-checkbox')) {
        updateSaveButton();
      }
    });

    function getSavedPapers() {
      const saved = localStorage.getItem('savedPapers');
      return saved ? JSON.parse(saved) : [];
    }

    function savePaper(paperData) {
      const saved = getSavedPapers();
      // 중복 체크
      if (!saved.find(p => p.pmid === paperData.pmid)) {
        saved.push({
          ...paperData,
          savedAt: new Date().toISOString()
        });
        localStorage.setItem('savedPapers', JSON.stringify(saved));
        return true;
      }
      return false;
    }

    saveBtn.addEventListener('click', () => {
      const checked = document.querySelectorAll('.paper-checkbox:checked');
      let savedCount = 0;
      checked.forEach(checkbox => {
        const paperData = {
          pmid: checkbox.dataset.pmid,
          title: checkbox.dataset.title,
          journal: checkbox.dataset.journal,
          date: checkbox.dataset.date,
          authors: checkbox.dataset.authors,
          link: checkbox.dataset.link
        };
        if (savePaper(paperData)) {
          savedCount++;
        }
        checkbox.checked = false;
      });
      updateSaveButton();
      if (savedCount > 0) {
        alert(`${savedCount} paper${savedCount !== 1 ? 's' : ''} saved.`);
      } else {
        alert('Papers already saved.');
      }
    });

    (function init(){
      lastQuery = getQuery();
      lastSort  = document.getElementById('sort').value;
      fetchPubMed(lastQuery, lastSort, false).then(setUpdated);
    })();
  </script>
</body>
</html>
