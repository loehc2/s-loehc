<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Saved Papers</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="referrer" content="no-referrer"/>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow py-6">
    <div class="container mx-auto px-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold text-gray-800">Saved Papers</h1>
      <div class="flex items-center gap-3">
        <span id="userEmail" class="text-sm text-gray-600 hidden"></span>
        <button id="loginBtn" class="px-3 py-1 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm">Google ë¡œê·¸ì¸</button>
        <button id="logoutBtn" class="px-3 py-1 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 text-sm hidden">ë¡œê·¸ì•„ì›ƒ</button>
        <a href="research.html" class="text-blue-600 hover:underline">Search</a>
        <a href="index.html" class="text-blue-600 hover:underline">â† Back</a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <div class="mb-4 flex items-center justify-between flex-wrap gap-2">
      <div class="flex items-center gap-3">
        <p id="paperCount" class="text-gray-600"></p>
        <span id="syncStatus" class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-600 hidden">
          <span id="syncIcon">ğŸ”„</span> <span id="syncText">Syncing...</span>
        </span>
      </div>
      <div class="flex gap-2">
        <button id="exportBtn" class="px-3 py-1 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm">Export</button>
        <label for="importFile" class="px-3 py-1 rounded-lg bg-green-600 text-white hover:bg-green-700 text-sm cursor-pointer">
          Import
          <input type="file" id="importFile" accept=".json" class="hidden" onchange="importPapers(event)">
        </label>
        <button id="clearAll" class="px-3 py-1 rounded-lg bg-red-600 text-white hover:bg-red-700 text-sm">Clear All</button>
      </div>
    </div>

    <!-- Category Tabs -->
    <div class="mb-6 flex flex-wrap gap-2 border-b border-gray-200 pb-2">
      <button class="tab-btn px-4 py-2 rounded-t-lg font-medium transition active" data-category="all">
        All <span id="count-all" class="ml-1 text-sm text-gray-500">(0)</span>
      </button>
      <button class="tab-btn px-4 py-2 rounded-t-lg font-medium transition" data-category="CoV">
        CoV <span id="count-CoV" class="ml-1 text-sm text-gray-500">(0)</span>
      </button>
      <button class="tab-btn px-4 py-2 rounded-t-lg font-medium transition" data-category="HIV">
        HIV <span id="count-HIV" class="ml-1 text-sm text-gray-500">(0)</span>
      </button>
      <button class="tab-btn px-4 py-2 rounded-t-lg font-medium transition" data-category="Flu">
        Flu <span id="count-Flu" class="ml-1 text-sm text-gray-500">(0)</span>
      </button>
      <button class="tab-btn px-4 py-2 rounded-t-lg font-medium transition" data-category="method">
        Method <span id="count-method" class="ml-1 text-sm text-gray-500">(0)</span>
      </button>
      <button class="tab-btn px-4 py-2 rounded-t-lg font-medium transition" data-category="Important">
        Important <span id="count-Important" class="ml-1 text-sm text-gray-500">(0)</span>
      </button>
      <button class="tab-btn px-4 py-2 rounded-t-lg font-medium transition" data-category="etc">
        etc <span id="count-etc" class="ml-1 text-sm text-gray-500">(0)</span>
      </button>
    </div>

    <div id="papersList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    
    <div id="emptyState" class="text-center py-12 hidden">
      <p class="text-gray-500 text-lg">No saved papers.</p>
      <a href="research.html" class="text-blue-600 hover:underline mt-4 inline-block">Go to Search</a>
    </div>
  </main>

  <footer class="bg-gray-800 text-white py-6 mt-12">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2025 SuncheolP</p>
    </div>
  </footer>

  <style>
    .tab-btn.active {
      background-color: #3b82f6;
      color: white;
    }
    .tab-btn.active span {
      color: rgba(255, 255, 255, 0.8);
    }
    .tab-btn:not(.active) {
      background-color: transparent;
      color: #6b7280;
    }
    .tab-btn:not(.active):hover {
      background-color: #f3f4f6;
    }
  </style>

  <script>
    let currentCategory = 'all';
    let firebaseInitialized = false;
    let database = null;
    let auth = null;
    let provider = null;
    let currentUser = null;
    let papersRef = null;

    // ============================================
    // Firebase ì„¤ì •
    // ============================================
    // ì•„ë˜ì— Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ ì„¤ì • ì •ë³´ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
    // FIREBASE_SETUP.md íŒŒì¼ì˜ 3ë‹¨ê³„ì—ì„œ ë³µì‚¬í•œ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”
    const firebaseConfig = {
      apiKey: "AIzaSyDYvtzLp2CaeMk14navRx9Sgum_J5rZsHo",
      authDomain: "fir-loehc-papers.firebaseapp.com",
      databaseURL: "https://fir-loehc-papers-default-rtdb.firebaseio.com",
      projectId: "fir-loehc-papers",
      storageBucket: "fir-loehc-papers.firebasestorage.app",
      messagingSenderId: "273353748384",
      appId: "1:273353748384:web:47aac0f88c3c666c56bec5",
      measurementId: "G-XKVJH93TKJ"
    };

    // Firebase ì´ˆê¸°í™”
    function initFirebase() {
      // ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
      if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes('AIza...')) {
        console.log('Firebase not configured. Using localStorage only.');
        updateSyncStatus('offline', 'Local only');
        return false;
      }

      try {
        if (!firebaseInitialized) {
          firebase.initializeApp(firebaseConfig);
          database = firebase.database();
          auth = firebase.auth();
          provider = new firebase.auth.GoogleAuthProvider();
          firebaseInitialized = true;
          console.log('Firebase initialized successfully');
        }
        return true;
      } catch (error) {
        console.error('Firebase initialization error:', error);
        updateSyncStatus('error', 'Sync error');
        return false;
      }
    }

    function startDatabaseSync() {
      if (!firebaseInitialized || !database || !auth || !auth.currentUser) {
        updateSyncStatus('offline', 'Sign in to sync');
        return;
      }

      if (!papersRef) {
        papersRef = database.ref('papers');
      }
      papersRef.off();

      loadFromFirebase();

      papersRef.on('value', (snapshot) => {
        const data = snapshot.val();
        // Only overwrite localStorage when remote DB actually has data
        let hasData = false;
        if (Array.isArray(data)) {
          hasData = data.length > 0;
        } else if (data && typeof data === 'object') {
          hasData = Object.keys(data).length > 0;
        }

        if (hasData) {
          const papers = Array.isArray(data) ? data : Object.values(data);
          localStorage.setItem('savedPapers', JSON.stringify(papers));
          displayPapers();
          updateSyncStatus('online', 'Synced');
        } else {
          // Do not overwrite localStorage with an empty remote value.
          // If remote is empty, keep local copy (if any) and show offline/no-data status.
          updateSyncStatus('offline', 'No remote data');
        }
      });
    }

    function stopDatabaseSync() {
      if (papersRef) {
        papersRef.off();
      }
    }

    // ë™ê¸°í™” ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateSyncStatus(status, text) {
      const syncStatus = document.getElementById('syncStatus');
      const syncIcon = document.getElementById('syncIcon');
      const syncText = document.getElementById('syncText');
      
      if (!syncStatus) return;
      
      syncStatus.classList.remove('hidden', 'bg-gray-200', 'bg-green-200', 'bg-red-200');
      syncText.textContent = text;
      
      if (status === 'online') {
        syncStatus.classList.add('bg-green-200', 'text-green-700');
        syncIcon.textContent = 'âœ“';
      } else if (status === 'offline') {
        syncStatus.classList.add('bg-gray-200', 'text-gray-600');
        syncIcon.textContent = 'â—‹';
      } else if (status === 'error') {
        syncStatus.classList.add('bg-red-200', 'text-red-700');
        syncIcon.textContent = 'âœ—';
      }
    }

    // ì¸ì¦ UI ë° ìƒíƒœ
    function updateAuthUI(user) {
      const userEmailEl = document.getElementById('userEmail');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');

      if (user) {
        userEmailEl.textContent = user.email;
        userEmailEl.classList.remove('hidden');
        logoutBtn.classList.remove('hidden');
        loginBtn.classList.add('hidden');
      } else {
        userEmailEl.classList.add('hidden');
        logoutBtn.classList.add('hidden');
        loginBtn.classList.remove('hidden');
      }
    }

    function initAuth() {
      if (!initFirebase()) return;
      auth.onAuthStateChanged((user) => {
        currentUser = user;
        updateAuthUI(user);
        if (user) {
          updateSyncStatus('online', 'Signed in');
          startDatabaseSync();
        } else {
          updateSyncStatus('offline', 'Sign in to sync');
          stopDatabaseSync();
        }
      });
    }

    function ensureSignedIn(actionName) {
      if (!auth || !auth.currentUser) {
        alert(`êµ¬ê¸€ ë¡œê·¸ì¸ í›„ ${actionName} ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
        return false;
      }
      return true;
    }

    function googleLogin() {
      if (!initFirebase()) return;
      auth.signInWithPopup(provider)
        .then((result) => {
          const user = result.user;
          console.log("ë¡œê·¸ì¸ ì„±ê³µ:", user.email);
        })
        .catch((err) => {
          console.error(err);
          alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        });
    }

    function googleLogout() {
      if (!auth) return;
      auth.signOut().catch((err) => {
        console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', err);
      });
    }

    // Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ
    function loadFromFirebase() {
      if (!firebaseInitialized || !database || !auth || !auth.currentUser) return;
      
      database.ref('papers').once('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          const papers = Array.isArray(data) ? data : Object.values(data);
          const localPapers = getSavedPapers();
          
          // Firebase ë°ì´í„°ê°€ ë” ìµœì‹ ì´ë©´ ë³‘í•©
          if (papers.length > 0) {
            const merged = mergePapers(localPapers, papers);
            localStorage.setItem('savedPapers', JSON.stringify(merged));
            saveToFirebase(merged, true);
            displayPapers();
          }
        }
      });
    }

    // Firebaseì— ë°ì´í„° ì €ì¥
    function saveToFirebase(papers, skipAuthCheck = false) {
      if (!firebaseInitialized || !auth || !auth.currentUser) {
        if (!skipAuthCheck) {
          updateSyncStatus('offline', 'Sign in to sync');
        }
        return;
      }
      // Avoid writing an empty array to remote unintentionally
      if (Array.isArray(papers) && papers.length === 0) {
        console.warn('saveToFirebase: empty papers array â€” skipping remote save to avoid data loss');
        updateSyncStatus('offline', 'No data to save');
        return;
      }

      try {
        updateSyncStatus('online', 'Syncing...');
        database.ref('papers').set(papers).then(() => {
          console.log('Saved to Firebase');
          updateSyncStatus('online', 'Synced');
        }).catch((error) => {
          console.error('Firebase save error:', error);
          updateSyncStatus('error', 'Sync failed');
        });
      } catch (error) {
        console.error('Firebase save error:', error);
        updateSyncStatus('error', 'Sync failed');
      }
    }

    // ë…¼ë¬¸ ë°ì´í„° ë³‘í•© (ì¤‘ë³µ ì œê±°)
    function mergePapers(local, remote) {
      const merged = [...local];
      const localPmids = new Set(local.map(p => p.pmid));
      
      remote.forEach(paper => {
        if (!localPmids.has(paper.pmid)) {
          merged.push(paper);
        } else {
          // ê¸°ì¡´ ë…¼ë¬¸ ì—…ë°ì´íŠ¸ (ì¹´í…Œê³ ë¦¬ ë“±)
          const index = merged.findIndex(p => p.pmid === paper.pmid);
          if (index !== -1) {
            merged[index] = { ...merged[index], ...paper };
          }
        }
      });
      
      return merged;
    }

    // ============================================
    // ê¸°ì¡´ localStorage í•¨ìˆ˜ë“¤ (Firebaseì™€ í†µí•©)
    // ============================================
    function getSavedPapers() {
      const saved = localStorage.getItem('savedPapers');
      return saved ? JSON.parse(saved) : [];
    }

    function savePapers(papers, skipAuthCheck = false) {
      if (!skipAuthCheck && !ensureSignedIn('ì €ì¥')) {
        return;
      }
      localStorage.setItem('savedPapers', JSON.stringify(papers));
      // Firebaseì—ë„ ì €ì¥
      if (firebaseInitialized && auth && auth.currentUser) {
        saveToFirebase(papers, skipAuthCheck);
      }
    }

    function removePaper(pmid) {
      if (!ensureSignedIn('ì‚­ì œ')) return;
      const saved = getSavedPapers();
      const filtered = saved.filter(p => p.pmid !== pmid);
      savePapers(filtered, true);
      displayPapers();
    }

    function updateCategory(pmid, category) {
      if (!ensureSignedIn('ì¹´í…Œê³ ë¦¬ ë³€ê²½')) return;
      const saved = getSavedPapers();
      const paper = saved.find(p => p.pmid === pmid);
      if (paper) {
        paper.category = category || 'etc';
        savePapers(saved, true);
        displayPapers();
      }
    }

    function clearAllPapers() {
      if (!ensureSignedIn('ì „ì²´ ì‚­ì œ')) return;
      if (confirm('Are you sure you want to delete all saved papers?')) {
        localStorage.removeItem('savedPapers');
        if (firebaseInitialized && auth && auth.currentUser) {
          database.ref('papers').set(null);
        }
        displayPapers();
      }
    }

    function exportPapers() {
      const papers = getSavedPapers();
      if (papers.length === 0) {
        alert('No papers to export.');
        return;
      }
      const dataStr = JSON.stringify(papers, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `saved-papers-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function importPapers(event) {
      if (!ensureSignedIn('ê°€ì ¸ì˜¤ê¸°')) return;
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) {
            alert('Invalid file format.');
            return;
          }

          const current = getSavedPapers();
          const existingPmids = new Set(current.map(p => p.pmid));
          
          // Merge: keep existing papers, add new ones
          let added = 0;
          let skipped = 0;
          
          imported.forEach(paper => {
            if (!existingPmids.has(paper.pmid)) {
              current.push(paper);
              existingPmids.add(paper.pmid);
              added++;
            } else {
              skipped++;
            }
          });

          savePapers(current, true);
          displayPapers();
          
          alert(`Import complete: ${added} new papers added, ${skipped} duplicates skipped.`);
        } catch (error) {
          alert('Error reading file: ' + error.message);
        }
      };
      reader.readAsText(file);
      // Reset input
      event.target.value = '';
    }

    function getCategoryCounts(papers) {
      const counts = { all: papers.length, CoV: 0, HIV: 0, Flu: 0, method: 0, Important: 0, etc: 0 };
      papers.forEach(paper => {
        const cat = paper.category || 'etc';
        if (counts.hasOwnProperty(cat)) {
          counts[cat]++;
        } else {
          counts.etc++;
        }
      });
      return counts;
    }

    function updateCategoryCounts(papers) {
      const counts = getCategoryCounts(papers);
      Object.keys(counts).forEach(cat => {
        const countEl = document.getElementById(`count-${cat}`);
        if (countEl) {
          countEl.textContent = `(${counts[cat]})`;
        }
      });
    }

    function displayPapers() {
      const allPapers = getSavedPapers();
      const papersList = document.getElementById('papersList');
      const emptyState = document.getElementById('emptyState');
      const paperCount = document.getElementById('paperCount');
      const clearAllBtn = document.getElementById('clearAll');

      // Filter by category
      const papers = currentCategory === 'all' 
        ? allPapers 
        : allPapers.filter(p => (p.category || 'etc') === currentCategory);

      paperCount.textContent = `${papers.length} paper${papers.length !== 1 ? 's' : ''} ${currentCategory === 'all' ? 'saved' : `in ${currentCategory}`}`;
      clearAllBtn.classList.toggle('hidden', allPapers.length === 0);

      updateCategoryCounts(allPapers);

      if (papers.length === 0) {
        papersList.innerHTML = '';
        if (currentCategory === 'all') {
          emptyState.classList.remove('hidden');
        } else {
          emptyState.innerHTML = `
            <p class="text-gray-500 text-lg">No papers in ${currentCategory} category.</p>
            <a href="research.html" class="text-blue-600 hover:underline mt-4 inline-block">Go to Search</a>
          `;
          emptyState.classList.remove('hidden');
        }
        return;
      }

      emptyState.classList.add('hidden');
      papersList.innerHTML = '';

      // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ (ì €ì¥ ì‹œê°„ ê¸°ì¤€)
      papers.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));

      papers.forEach(paper => {
        const card = document.createElement('div');
        card.className = 'relative bg-white rounded-xl shadow hover:shadow-lg transition p-4';
        const savedDate = new Date(paper.savedAt).toLocaleDateString('en-US');
        const currentCat = paper.category || 'etc';
        card.innerHTML = `
          <a href="${paper.link}" target="_blank" rel="noopener" class="block">
            <div class="text-lg font-semibold text-gray-800 mb-1">${paper.title}</div>
            <div class="text-sm text-gray-600">${paper.journal} Â· ${paper.date}</div>
            <div class="text-sm text-gray-600 truncate">${paper.authors}</div>
            <div class="mt-2 text-blue-600 text-sm">PMID: ${paper.pmid}</div>
            <div class="mt-2 text-xs text-gray-400">Saved: ${savedDate}</div>
          </a>
          <div class="mt-3 flex items-center gap-2 pt-2 border-t border-gray-200">
            <select class="category-select text-xs border rounded px-2 py-1" 
                    data-pmid="${paper.pmid}" 
                    onchange="updateCategory('${paper.pmid}', this.value)">
              <option value="CoV" ${currentCat === 'CoV' ? 'selected' : ''}>CoV</option>
              <option value="HIV" ${currentCat === 'HIV' ? 'selected' : ''}>HIV</option>
              <option value="Flu" ${currentCat === 'Flu' ? 'selected' : ''}>Flu</option>
              <option value="method" ${currentCat === 'method' ? 'selected' : ''}>Method</option>
              <option value="Important" ${currentCat === 'Important' ? 'selected' : ''}>Important</option>
              <option value="etc" ${currentCat === 'etc' ? 'selected' : ''}>etc</option>
            </select>
            <button class="text-red-600 hover:text-red-800" 
                    onclick="removePaper('${paper.pmid}')" 
                    title="Delete">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        `;
        papersList.appendChild(card);
      });
    }

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentCategory = btn.dataset.category;
        displayPapers();
      });
    });

    document.getElementById('exportBtn').addEventListener('click', exportPapers);
    document.getElementById('clearAll').addEventListener('click', clearAllPapers);
    document.getElementById('loginBtn').addEventListener('click', googleLogin);
    document.getElementById('logoutBtn').addEventListener('click', googleLogout);

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (onclickì—ì„œ ì‚¬ìš©)
    window.removePaper = removePaper;
    window.updateCategory = updateCategory;
    window.importPapers = importPapers;

    // ì´ˆê¸° ë¡œë“œ
    // Firebase ì´ˆê¸°í™” ì‹œë„ (ì„¤ì •ì´ ì—†ìœ¼ë©´ localStorageë§Œ ì‚¬ìš©)
    initFirebase();
    initAuth();
    
    // Firebase ì´ˆê¸°í™” í›„ì—ë„ displayPapers í˜¸ì¶œ (localStorage ë°ì´í„° í‘œì‹œ)
    displayPapers();
  </script>
</body>
</html>
